!function(){"use strict";function e(e){e=Object.assign({},o,e);var t=new XMLHttpRequest;if(t.onreadystatechange=function(){4==this.readyState&&(200==this.status?e.success&&e.success(this.response):e.error&&error.success(this.response))},"GET"===e.method){var n=i(e.data),r=e.url+(n?"?"+n:"");t.open(e.method,r,e.async),t.send()}else"POST"===e.method&&(t.open(e.method,e.url,e.async),t.send(e.data));return t}function t(e,t,n){return n||(n=t,t=null),Ajax.ajax({url:e,data:t,success:n,method:"GET"})}function n(e,t,n){return n||(n=t,t=null),Ajax.ajax({url:e,data:t,success:function(e){n(JSON.parse(e))},method:"GET"})}function r(e,t,n){return n||(n=t,t=null),Ajax.ajax({url:e,data:t,success:n,method:"POST"})}function i(e){var t="";for(var n in e){t+="&"+(n+"="+encodeURIComponent(e[n]))}return t.slice(1)}var o={method:"GET",url:"",data:{},async:!0,success:null,error:null};window.Ajax={ajax:e,get:t,getJSON:n,post:r}}(),function(){"use strict";function e(e,t,n){e[t]||(e[t]=n)}e(Array.prototype,"unique",function(){for(var e=this.concat(),t=0;t<e.length;++t)for(var n=t+1;n<e.length;++n)e[t]===e[n]&&e.splice(n--,1);return e}),e(Array.prototype,"forEach",function(e){for(var t=0;t<this.length;t++)e(this[t],t,this)})}(),function(){"use strict";function e(e,t,n){e[t]||(e[t]=n)}function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}e(HTMLElement.prototype,"addClass",function(){var e,t;for(var n in arguments)e=this.className?this.className.trim().replace(/\s+/g," ").split(" "):[],t=arguments[n]?arguments[n].trim().replace(/\s+/g," ").split(" "):[],this.className=e.concat(t).unique().join(" ")}),e(HTMLElement.prototype,"hasClass",function(){var e,t=this.className?this.className.trim().replace(/\s+/g," ").split(" "):[];for(var n in arguments){e=arguments[n]?arguments[n].trim().replace(/\s+/g," ").split(" "):[];for(var r=0;r<e.length;r++){var i=e[r];if(-1==t.indexOf(i))return!1}}return!0}),e(HTMLElement.prototype,"removeClass",function(){var e,t,n=0,r=function(t){-1!=(n=e.indexOf(t))&&e.splice(n,1)};for(var i in arguments)e=this.className?this.className.trim().replace(/\s+/g," ").split(" "):[],t=arguments[i]?arguments[i].trim().replace(/\s+/g," ").split(" "):[],t.forEach(r),this.className=e.unique().join(" ")}),e(HTMLElement.prototype,"data",function(e,t){window.__data_cache||(window.__data_cache=new WeakMap);var n=window.__data_cache.get(this)||{};return void 0===t?e?n&&n[e]:n:(n[e]=t,window.__data_cache.set(this,n),this)}),e(HTMLElement.prototype,"setData",function(e){return window.__data_cache||(window.__data_cache=new WeakMap),window.__data_cache.set(this,e),this}),e(HTMLElement.prototype,"attr",function(e,t){if(void 0!==t)this.setAttribute(e,t);else{if(null!==t)return this.getAttribute(e);this.removeAttribute(e)}return this}),e(HTMLElement.prototype,"attrData",function(e,t){return this.attr("data-"+e,t)}),e(Element.prototype,"matches",Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||Element.prototype.webkitMatchesSelector||function(e){for(var t=(this.document||this.ownerDocument).querySelectorAll(e),n=t.length;--n>=0&&t.item(n)!==this;);return n>-1}),e(HTMLElement.prototype,"parent",function(e){if(!e)return this.parentElement;for(var t=this.parentElement;!t.matches(e);)t=t.parentElement;return t}),e(HTMLElement.prototype,"height",function(){if(1!=arguments.length)return this.clientHeight;var e=arguments[0];this.style.height="number"==typeof e?e+"px":e}),e(HTMLElement.prototype,"width",function(){if(1!=arguments.length)return this.clientWidth;var e=arguments[0];this.style.width="number"==typeof e?e+"px":e}),e(window,"guid",function(){return"GUID-"+t()+"-"+t()+"-"+t()}),e(HTMLElement.prototype,"guid",function(){var e=null,t=null;do{e=window.guid(),t=document.querySelector("#"+e)}while(t);return this.attr("id",e),e})}(),function(){"use strict";function e(e,t,n){e[t]||(e[t]=n)}e(Object,"clone",function(e){var t={};for(var n in e)if(e.hasOwnProperty(n)){var r=e[n];t[n]="object"==typeof r?Object.clone(e[n]):e[n]}return t}),e(Object,"assign",function(e,t){if(null===e)throw new TypeError("Cannot convert undefined or null to object");for(var n=Object(e),r=Object.prototype.hasOwnProperty,i=1;i<arguments.length;i++){var o=arguments[i];if(null!==o)for(var a in o)r.call(o,a)&&(n[a]=o[a])}return n}),e(Object,"extend",function(e,t){return Object.assign({},t,e)})}(),function(){"use strict";var e=function(e,t){this.parent=e||null,this.data=t||{},this.children=[]};window.TreeNode=e,e.prototype.isRoot=function(){return!this.parent},e.prototype.add=function(e){var t=new this.constructor(this,e);return this.children.push(t),t},e.prototype.remove=function(e){return this.children.slice(e,1),this},e.prototype.dfs=function(e){for(var t=[],n=0;n<this.children.length;n++)(!e||e&&e(this.children[n]))&&t.push(this.children[n]),t.concat(this.children[n].dfs(e));return t},e.prototype.bfs=function(e){var t,n=[];for(t=0;t<this.children.length;t++)(!e||e&&e(this.children[t]))&&n.push(this.children[t]);for(t=0;t<this.children.length;t++)n.concat(this.children[t].bfs(e));return n},e.extend=function(){var t=function(t,n){e.call(this,t,n)};return t.prototype=Object.create(e.prototype),t.prototype.constructor=t,new t}}(),function(){"use strict";var e=function(e){this.isDebug=!!e,this.listeners={}};e.prototype.trigger=function(){var e=arguments[0],t=this.listeners[e]||[];Array.prototype.splice.call(arguments,0,1),this.isDebug&&console.debug(e,arguments);for(var n=0;n<t.length;n++)t[n].apply(null,arguments)},e.prototype.on=function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)},e.prototype.off=function(e){delete this.listeners[e]},e.prototype.off=function(e,t){if(this.listeners[e]){var n=this.listeners[e];n.indexOf(t)>-1&&n.splice(index,1)}},e.prototype.reset=function(){var e=this;Object.keys(this.listeners).forEach(function(t){delete e.listeners[t]})},window.EventHandler=e}(),function(){"use strict";var e=function(t){this.handlers=[],this.addHandler(this.level.ALL,function(t,n){e.prototype.level.DEBUG===t?console.debug.apply(this,n):e.prototype.level.INFO===t?console.info.apply(this,n):e.prototype.level.WARNING===t?console.warn.apply(this,n):e.prototype.level.ERROR===t&&console.error.apply(this,n)})};e.prototype.debug=function(){this.log(e.prototype.level.DEBUG,arguments)},e.prototype.info=function(){this.log(e.prototype.level.INFO,arguments)},e.prototype.warning=function(){this.log(e.prototype.level.WARNING,arguments)},e.prototype.error=function(){this.log(e.prototype.level.ERROR,arguments)},e.prototype.log=function(e,t){for(var n=e,r=this.handlers[n]||[];n>=0;)r.forEach(function(n){n(e,t)}),r=this.handlers[--n]||[]},e.prototype.addHandler=function(e,t){this.handlers[e]||(this.handlers[e]=[]),this.handlers[e].push(t)},e.prototype.removeHandler=function(e,t){var n=this.handlers[e];if(n){var r=n.indexOf(t);r>-1&&n.splice(r,1)}},e.prototype.level={ALL:0,DEBUG:1,INFO:2,WARNING:3,ERROR:4,NONE:5},window.Logger=e}(),function(){"use strict";var e={container:{selector:"#cobweb"}},t=function(t){this.options=Object.assign({},e,t);var n=this;if(this.container=document.querySelector(this.options.container.selector),!this.container)throw new Error("Invalid container selector: '"+this.options.container.selector+"'");this.container.addClass("cb-container"),this.container.data("instance",this),this.logger=new Logger(this,!0),this.events=new EventHandler(!0),this.modules=new Modules([this],{onLoadedAll:function(e){n.events.trigger("modules.loaded.all",e),n.events.trigger("app.loaded")}})};window.Cobweb=t}(),function(){"use strict";function e(e){var r=[],i=null,o=0;for(var a in e)for(i=e[a],o=0;o<i.dependencies.length;o++){var s=i.dependencies[o];if(!e[s])throw new Error("Missing module: "+s)}for(var c=null,l=t(e);l.length>0;)if(c=l.splice(0,1)[0],i=e[c])for(r.push(c),o=0;o<i.dependant.length;o++){var u=i.dependant[o];n(r,e[u])&&l.push(u)}if(Object.keys(e).length!==r.length)throw new Error("Dependency cycle!");return r}function t(e){var t=[];for(var n in e)0===e[n].dependencies.length&&t.push(n);return t}function n(e,t){for(var n=0;n<t.dependencies.length;n++)if(-1===e.indexOf(t.dependencies[n]))return!1;return!0}function r(e,t,n){var r=e[t];"function"==typeof r&&r.apply(null,n)}var i=function(t,n){n=n||{};var o=i.prototype.all;try{for(var a=e(o),s=0;s<a.length;s++){var c=a[s],l=o[c];try{l.init.apply(this,t),r(n,"onLoaded",[c,l])}catch(e){console.error("Error loading module:",c,e),r(n,"onError",[e,c,l])}}r(n,"onLoadedAll",[a])}catch(e){console.error("Error loading modules:",e)}};i.prototype.all={},i.prototype.add=function(e,t,n){n=n||[];var r,i,o=[];for(var a in this.all){var s=this.all[a];for(i=0;i<s.dependencies.length;i++)s.dependencies[i]===e&&o.push(a)}for(i=0;i<n.length;i++)(r=this.all[n[i]])&&r.dependant.push(e);this.all[e]={dependencies:n,dependant:o,init:t}},window.Modules=i}(),function(){"use strict";Modules.prototype.add("mesh",function(e){e.asset=e.asset||{},e.asset.mesh={get:function(t,n){Ajax.get("asset/mesh/"+t+".obj",function(t){n(e.asset.mesh.build(t))})},build:function(e){var t=null,n=[];return e.split(/\r?\n/).forEach(function(e){if(e.startsWith("v")){var r=e.substring(2).split(" ").map(function(e){return parseFloat(e)});n.push(r)}else if(e.startsWith("f")){null===t&&(t=new Math.HalfEdgeMesh,t.addVertices(n));var i=e.substring(2).split(" ").map(function(e){return n[parseInt(e)-1]});t.addFace(i)}}),t}}})}(),function(){"use strict";Modules.prototype.add("shader",function(e){e.asset=e.asset||{},e.asset.shader={get:function(e,t){var n=null,r=null;Ajax.get("asset/shader/"+e+".vert",function(e){r&&(n=new Shader(e,r),t(n)),r=e}),Ajax.get("asset/shader/"+e+".frag",function(e){r&&(n=new Shader(r,e),t(n)),r=e})}}})}(),function(){"use strict";var e=function(e,t,n){this.center=e||[0,0,0],this.rotation=t||[2.8,.5],this.distance=n||15,this.projection=mat4.create(),this.ortho=mat4.create(),this.height=0,this.width=0};e.prototype.getViewMatrix=function(e){e=e||mat4.create();var t=[0,0,0];return this.getPosition(t),mat4.lookAt(e,t,this.center,this.getUpDirection()),e},e.prototype.getPosition=function(e){return e=e||vec3.create(),vec3.set(e,0,0,-this.distance),vec3.rotateX(e,e,this.rotation[1]),vec3.rotateY(e,e,-this.rotation[0]),e},e.prototype.getDirection=function(e){e=e||vec3.create();var t=this.getPosition();return vec3.sub(e,this.center,t),vec3.normalize(e,e),e},e.prototype.getRay=function(e,t,n){e=e||new Math.Ray,this.getPosition(e.start),vec3.set(e.direction,t[0]/(.5*n[0])-1,t[1]/(.5*n[1])-1,1);var r=mat4.create();return mat4.multiply(r,this.projection,this.getViewMatrix()),mat4.invert(r,r),vec3.transformMat4(e.direction,e.direction,r),vec3.normalize(e.direction,e.direction),e},e.prototype.getUpDirection=function(e){e=e||vec3.create();var t=this.rotation[1];return t>=Math.PI/2&&t<=3*Math.PI/2?vec3.set(e,0,1,0):vec3.set(e,0,-1,0),e},e.prototype.computeLocalAxis=function(){var e=[0,0,0],t=[0,0,0],n=this.getDirection();return vec3.cross(e,n,[0,1,0]),vec3.cross(t,n,e),{up:t,left:e}},window.Math.Camera=e}(),function(){"use strict";function e(e,t){for(var n=0;n<3;n++){if(e[n]<t.min[n])return!1;if(e[n]>t.max[n])return!1}return!0}function t(e,t){for(var n=e;n&&!n.canContain(t);)n=n.parent;return n}var n={maxItems:10,maxDepth:10,padding:.1},r=function(e,t){for(this.items=[],this.children=null,this.depth=t||0,this.parent=e||null,this.aabb={max:[0,0,0],min:[0,0,0]},this.root=this;null!==this.root.parent;)this.root=this.root.parent};r.prototype.getAllItems=function(e){e=e||[];var t;if(this.children)for(t=0;t<this.children.length;t++)e=this.children[t].getAllItems(e);else e=e.concat(this.items);return e},r.prototype.addItems=function(e){for(var t=!1,n=0;n<e.length;n++){var r=e[n];t|=this.addItem(r)}return t},r.prototype.addItem=function(e){if(this.canContain(e)){if(!this.children)return this.items.push(e),this.splitIfNeeded(),!0;for(var t=0;t<8;t++)if(this.children[t].addItem(e))return!0}return!1},r.prototype.removeItem=function(e){var t=!1,n=this.items.indexOf(e);if(n>-1)this.items.splice(n,1),this.mergeIfNeeded(),t=!0;else if(this.children)for(var r=0;r<this.children.length&&!(t|=this.children[r].removeItem(e));r++);return t&&this.mergeIfNeeded(),t},r.prototype.splitIfNeeded=function(){if(this.root.options.maxItems<this.items.length&&this.root.options.maxDepth>this.depth){this.children=[];for(var e=0;e<8;e++)this.children[e]=new r(this,this.depth+1),this.children[e].updateDimensions(this.aabb,e);this.redistributeItems(this.items),this.items=[]}},r.prototype.mergeIfNeeded=function(){if(this.children){for(var e=0;e<8;e++)if(this.children[e].mergeIfNeeded(),!!this.children[e].children)return!1;var t=this.getAllItems();return this.root.options.maxItems>t.length&&(this.children=null,this.redistributeItems(t),!0)}return!1},r.prototype.canContain=function(t){return e(t,this.aabb)},r.prototype.getCollidingNodes=function(e){var t=[],n=(this.aabb,[0,0,0]);if(Math.geo.rayAABBCollision(e.start,e.direction,this.aabb.min,this.aabb.max,n))if(this.children)for(var r=0;r<this.children.length;r++){var i=this.children[r];t=t.concat(i.getCollidingNodes(e))}else t.push(this);return t},r.prototype.getCollidingItems=function(e){var t=[];return this.getCollidingNodes(e).forEach(function(e){t=t.concat(e.items)}),t},r.prototype.updateDimensions=function(e,t){var n=[0,0,0];vec3.sub(n,e.max,e.min),vec3.scale(n,n,.5);var r=[!(1&t),!(2&t),!(4&t)];if(vec3.mul(this.aabb.min,n,r),vec3.add(this.aabb.min,this.aabb.min,e.min),vec3.add(this.aabb.max,this.aabb.min,n),this.children)for(var i=0;i<this.children.length;i++)this.children[i].updateDimensions(this.aabb,i)},r.prototype.redistributeItems=function(e){e=e||this.items;for(var n=0;n<e.length;n++){var r=e[n],i=t(this,r);null===i&&(console.warn("Recomputing bounds..."),this.root.updateDimensions([r]),i=t(this,r)),i.addItem(r)}};var i=function(e){this.options=Object.assign({},n,e),r.call(this)};i.prototype=Object.create(r.prototype),i.prototype.constructor=r;var o=i.prototype.addItem;i.prototype.addItem=function(e){return this.canContain(e)||this.updateDimensions([e]),o.call(this,e)},i.prototype.onVerticesMove=function(e){for(var t=0;t<e.length;t++)this.removeItem(e[t])&&this.addItem(e[t])},i.prototype.updateDimensions=function(e){var t=this.getAllItems(e);if(this.updateBounds(t),this.children)for(var n=0;n<this.children.length;n++)this.children[n].updateDimensions(this.aabb,n)},i.prototype.updateBounds=function(e){var t=[0,0,0].fill(-Number.MAX_VALUE),n=[0,0,0].fill(Number.MAX_VALUE),r=this.options.padding;e.forEach(function(e){for(var i=0;i<3;i++)n[i]=Math.min(n[i],e[i]-r),t[i]=Math.max(t[i],e[i]+r)}),vec3.copy(this.aabb.min,n),vec3.copy(this.aabb.max,t)},Math.Octree=i}(),function(){"use strict";var e=function(e,t){this.normal=t||[0,1,0],this.point=e||vec3.create(),vec3.normalize(this.normal,this.normal)};window.Math.Plane=e}(),function(){"use strict";var e=function(e,t){this.direction=t||[0,0,1],this.start=e||vec3.create(),vec3.normalize(this.direction,this.direction)};e.fromPoints=function(t,n){var r=vec3.create();return vec3.sub(r,n,t),new e(t,r)},window.Math.Ray=e}(),function(){"use strict";Modules.prototype.add("pane-types",function(e){e.events.on("pane.split",function(t,n){var r=t.attrData("pane-type");r&&e.pane.setType(n,r)}),e.pane.types={},e.pane.setType=function(t,n){if(this.types[n]){this.types[n].onPaneType(t,e),t.dataset.paneType=n}}},["pane"])}(),function(){"use strict";Modules.prototype.add("pane",function(e){function t(t){e.events.trigger("pane.create",t)}function n(t,n){e.events.trigger("pane.split",t,n)}function r(t){e.events.trigger("pane.resize",t)}var i=document.createElement("div");i.className="main-panes",document.querySelector(e.options.container.selector).appendChild(i),e.events.on("app.loaded",function(){e.pane.internal=new Pane({container:"div.main-panes",separator:{size:3},callbacks:{onPaneCreate:t,onPaneSplit:n,onPaneResize:r}});var i=e.pane.internal.container.querySelector(".pane");e.pane.setType(i,"surface")}),e.pane={}})}(),function(){"use strict";function e(e,t,r,i){var o=n(e,t),a=n(e,r),s=n(e,i),c=vec3.dot(o,o),l=vec3.dot(o,a),u=vec3.dot(a,a),d=vec3.dot(s,o),h=vec3.dot(s,a),f=c*u-l*l,v=[(u*d-l*h)/f,(c*h-l*d)/f,0];return v[2]=1-v[0]-v[1],v}function t(e,t,n){var r=vec3.create(),i=vec3.create();return vec3.sub(r,t,e),vec3.sub(i,n,e),vec3.cross(r,r,i),r}function n(e,t){var n=vec3.create();return vec3.sub(n,t,e),n}Math.geo=Math.geo||{},Math.geo.rayFaceCollision=function(e,t,n,r){for(var i=Math.geo.triangulateFace(n),o=0;o<i.length;o++){var a=i[o];if(Math.geo.rayTriangleCollision(e,t,a[0],a[1],a[2],r))return!0}return!1},Math.geo.rayTriangleCollision=function(n,r,i,o,a,s){s=s||[0,0,0];var c=t(i,o,a);if(Math.geo.rayPlaneCollision(n,r,i,c,s)){var l=e(i,o,a,s);return l[0]<=1&&l[0]>=0&&l[1]<=1&&l[1]>=0&&l[2]<=1&&l[2]>=0}return!1},Math.geo.rayPlaneCollision=function(e,t,n,r,i){var o=vec3.dot(n,r)-vec3.dot(r,e),a=vec3.dot(r,t);if(Math.abs(a)<1e-6)return!1;var s=o/a;return!(s<0)&&(i&&(vec3.scale(i,t,s),vec3.add(i,e,i)),!0)},Math.geo.rayAABBCollision=function(e,t,n,r,i){i=i||vec3.create();var o,a=!0,s=new Float32Array(3),c=0,l=new Float32Array(3),u=new Float32Array(3);for(c=0;c<3;++c)e[c]<n[c]?(s[c]=1,u[c]=n[c],a=!1):e[c]>r[c]?(s[c]=0,u[c]=r[c],a=!1):s[c]=2;if(a)return vec3.copy(i,e),!0;for(c=0;c<3;++c)2!==s[c]&&0!==t[c]?l[c]=(u[c]-e[c])/t[c]:l[c]=-1;for(o=0,c=1;c<3;c++)l[o]<l[c]&&(o=c);if(l[o]<0)return!1;if(l[o]>Number.MAX_VALUE)return!1;for(c=0;c<3;++c)if(o!=c){if(i[c]=e[c]+l[o]*t[c],i[c]<n[c]||i[c]>r[c])return!1}else i[c]=u[c];return!0},Math.geo.closestPointsBetweenSegments=function(e,t,n,r,i,o){var a,s,c=vec3.subtract(vec3.create(),t,e),l=vec3.subtract(vec3.create(),r,n),u=vec3.subtract(vec3.create(),e,n),d=vec3.dot(c,c),h=vec3.dot(c,l),f=vec3.dot(l,l),v=vec3.dot(c,u),p=vec3.dot(l,u),g=d*f-h*h;g<1e-6?(a=0,s=h>f?v/h:p/f):(a=(h*p-f*v)/g,s=(d*p-h*v)/g),i&&vec3.add(i,e,vec3.scale(vec3.create(),c,a)),o&&vec3.add(o,n,vec3.scale(vec3.create(),l,s));var m=vec3.add(vec3.create(),u,vec3.subtract(vec3.create(),vec3.scale(vec3.create(),c,a),vec3.scale(vec3.create(),l,s)));return vec3.length(m)},Math.geo.rayPointDistance=function(e,t,n){var r=[0,0,0];return vec3.sub(r,n,e),vec3.cross(r,t,r),vec3.len(r)},Math.geo.pointPointDistance=function(e,t){var n=[0,0,0];return vec3.sub(n,t,e),vec3.len(n)},Math.geo.triangulateFace=function(e){for(var t=[],n=0;n<e.length-2;n++)t.push([e[0],e[n+1],e[n+2]]);return t},Math.geo.computePointsCenter=function(e){if(!e||0===e.length)return null;var t=[0,0,0];return e.forEach(function(e){vec3.add(t,t,e)}),vec3.scale(t,t,1/e.length),t},Math.geo.findClosestPointIndex=function(e,t){if(!t||!t.length)return null;for(var n=Math.geo.pointPointDistance(e,t[0]),r=0,i=1;i<t.length;i++){var o=Math.geo.pointPointDistance(e,t[i]);o<n&&(n=o,r=i)}return r},Math.geo.findClosestPoint=function(e,t){return t&&t.length?t[Math.geo.findClosestPointIndex(e,t)]:null},Math.geo.findClosestFace=function(e,t){if(!t||!t.length)return null;var n=t.map(function(e){return e.computeCenter()});return t[Math.geo.findClosestPointIndex(e,n)]}}(),function(){"use strict";Modules.prototype.add("halfedge-cache",function(e){var t=Math.HalfEdgeMesh,n=function(){t.call(this);var e=this;this.cache={meshes:{},get:function(t){var n=this.meshes[t],r=Math.HalfEdgeMesh.prototype.builders[t];return n&&!n.rebuild||(n=r.onCreate(e),e.rebuild=!1,this.meshes[t]=n),r.onClean&&r.onClean(n),n},onVerticesChange:function(e){for(var t in this.meshes){var n=this.meshes[t],r=Math.HalfEdgeMesh.prototype.builders[t];r.onVerticesChange&&r.onVerticesChange(e,n)}}}};n.prototype=Object.create(Math.HalfEdgeMesh.prototype),n.prototype.constructor=n,Math.HalfEdgeMesh=n;var r=Math.HalfEdgeMesh.prototype.addVertices;Math.HalfEdgeMesh.prototype.addVertices=function(e){r.call(this,e),this.invalidateCache()};var i=Math.HalfEdgeMesh.prototype.addFace;Math.HalfEdgeMesh.prototype.addFace=function(e){var t=i.call(this,e);return this.invalidateCache(),t},Math.HalfEdgeMesh.prototype.invalidateCache=function(){for(var e in this.cache.meshes)this.cache.meshes[e].rebuild=!0},Math.HalfEdgeMesh.prototype.builders={},Math.HalfEdgeMesh.prototype.addBuilder=function(e,t){this.builders[e]=t}},["halfedge"])}(),function(){"use strict";function e(e,n,r){var i={};return i.vertex=n,i.face=r||new a(i),i.opposite=t(e,n,i),e._halfEdge.outEdges.push(i),i.next=null,i}function t(e,t,n){var r=t._halfEdge.outEdges.filter(function(t){return t.vertex===e});if(r.length>0){var i=r[0];return i.opposite=n,i}return null}function n(){return this.outEdges.map(function(e){return e.face})}function r(){var e=[0,0,0];return this.getFaces().forEach(function(t){vec3.add(e,e,t.computeRawNormal())}),vec3.normalize(e,e),e}function i(e,t,n){var r=vec3.create(),i=vec3.create();return vec3.sub(r,t,e),vec3.sub(i,n,e),vec3.cross(r,r,i),r}Modules.prototype.add("halfedge",function(e){Math.HalfEdgeMesh=o});var o=function(){this.bounds=new Math.Octree,this.halfEdges=[],this.vertices=[],this.faces=[]};o.prototype.addVertices=function(e){if(arguments.length>1&&this.addVertices.apply(this,arguments),Array.isArray(e)){this.bounds.addItems(e);for(var t=0;t<e.length;t++){var i=e[t];if(this.vertices.indexOf(i)<0){var o=null;i._halfEdge?o=i._halfEdge:(o={},o.computeNormal=r,o.getFaces=n,o.outEdges=[],i._halfEdge=o),o.ownIndex=this.vertices.length,this.vertices.push(i)}else console.error("addVertices: Adding vertex twice!",i)}}},o.prototype.addFace=function(t){if(arguments.length>1)return this.addFace.apply(this,arguments);if(!Array.isArray(t))return null;if(t.length>=3){var n=e(t[0],t[1]),r=e(t[1],t[2],n.face);n.next=r,this.halfEdges.push(n,r);for(var i,o=r,a=2;a<t.length-1;a++)i=e(t[a],t[a+1],n.face),o.next=i,this.halfEdges.push(i),o=i;return i=e(t[a],t[0],n.face),i.next=n,this.halfEdges.push(i),o.next=i,this.faces.push(n.face),n.face}return console.error("addFace: 3 or more vertices needed to form a face!"),null},o.prototype.onVerticesChange=function(e){this.cache&&this.cache.onVerticesChange&&this.cache.onVerticesChange(e),this.bounds.onVerticesMove(e)},o.prototype.clear=function(){this.halfEdges=[],this.vertices=[],this.faces=[]};var a=function(e){this.halfEdge=e};a.prototype.getEdges=function(){for(var e=[],t=this.halfEdge;t.next!==this.halfEdge;)if(e.push(t),null===(t=t.next));return e.push(t),e},a.prototype.getVertices=function(){return this.getEdges().map(function(e){return e.vertex})},a.prototype.getVerticesTriangulated=function(){for(var e=[],t=this.getVertices(),n=0;n<t.length-2;n++)e.push([t[0],t[n+1],t[n+2]]);return e},a.prototype.computeRawNormal=function(){var e=[0,0,0];return this.getVerticesTriangulated().forEach(function(t){var n=i(t[0],t[1],t[2]);vec3.add(e,e,n)}),e},a.prototype.computeNormal=function(){var e=this.computeRawNormal();return vec3.normalize(e,e),e},a.prototype.computeCenter=function(){return Math.geo.computePointsCenter(this.getVertices())}}(),function(){"use strict";function e(e,r){var i=document.createElement("canvas");i.id="surface"+n++,i.addEventListener("mouseover",function(e){e.target.focus()}),i.className="surface",e.appendChild(i),r.surface.map=r.surface.map||{},r.surface.map[i.id]={camera:new Math.Camera},t(r,e),r.events.trigger("surface.create",i)}function t(e,t){var n=t.querySelector("canvas"),r=n.getContext("2d"),i=e.surface.map[n.id],o=t.querySelector(".pane-header"),a=o?o.height():0,s=t.querySelector(".surface-toolbar"),c=s?s.width():0,l=t.width()-c,u=t.height()-a;n.height=u,n.width=l,r.setTransform(1,0,0,1,0,0),r.translate(0,u),r.scale(1,-1),i.camera.width=l,i.camera.height=u,mat4.perspective(i.camera.projection,45*DEG2RAD,l/u,.1,1e3),mat4.ortho(i.camera.ortho,0,l,0,u,-1,1)}Modules.prototype.add("surface",function(n){n.pane.types.surface={onPaneType:e},n.events.on("pane.resize",function(e){"surface"===e.attrData("pane-type")&&t(n,e)}),window.addEventListener("resize",function(e){for(var r=n.pane.internal.container.querySelectorAll(".pane canvas"),i=0;i<r.length;i++)t(n,r[i].parentNode)}),n.surface={}},["pane-types"]);var n=0}(),function(){"use strict";function e(e,t,r){if(t){o||(r[0]=-r[0]);var i=e.rotation;i[0]=t[0]+.005*r[0],i[1]=t[1]+.005*r[1],n(i)}}function t(e,t){return e?[e[0]-t[0],t[1]-e[1]]:[0,0]}function n(e){var t=2*Math.PI;e[0]<0&&(e[0]=t+e[0]),e[0]>=t&&(e[0]=e[0]-t),e[1]<0&&(e[1]=t+e[1]),e[1]>=t&&(e[1]=e[1]-t)}var r=null,i=null;Modules.prototype.add("common-interaction",function(n){n.surface.interactions.common={onMouseWheel:function(e,t){var r=e.target,i=Math.max(-1,Math.min(1,e.wheelDelta||-e.detail)),o=n.surface.map[r.id];return o.camera.distance-=i*o.camera.distance/25,!0},onMouseMove:function(o,a){if(o.target.dataset.moving){var s=o.target,c=n.surface.map[s.id];if(c){var l=t(i,a);e(c.camera,r,l)}}return!1},onMouseDown:function(e,t){var a=e.target,s=n.surface.map[a.id];return 3!==e.which||(e.target.dataset.moving="true",o=vec3.equals(s.camera.getUpDirection(),[0,1,0]),r=s.camera.rotation.slice(),i=t,!1)},onMouseUp:function(e,t){if(3===e.which){delete e.target.dataset.moving;n.surface.map[e.target.id];i=null}return!0}}},["surface-interaction"]);var o=!0}(),function(){"use strict";Modules.prototype.add("object-interaction",function(e){e.surface.interactions.object={onMouseDown:function(t,n){var r=t.target,i=e.surface.map[r.id];if(1===t.which){var o=i.camera.getRay(null,n,[r.width,r.height]),a=!1,s=vec3.create();return e.scene.getObjects().forEach(function(e){a=geo.testRayBBox(o.start,o.direction,e.data.mesh.bounding,e.data.model,s),a?e.data.selected=!0:delete e.data.selected}),!1}return!0}}},["surface-interaction"])}(),function(){"use strict";function e(e,n){var r=t(n);switch(n.type){case"keydown":if(e.onKeyDown)return e.onKeyDown(n);break;case"keyup":if(e.onKeyUp)return e.onKeyUp(n);break;case"mousewheel":if(e.onMouseWheel)return e.onMouseWheel(n,r);break;case"mousemove":if(e.onMouseMove)return e.onMouseMove(n,r);break;case"mousedown":if(e.onMouseDown)return e.onMouseDown(n,r);break;case"mouseup":if(e.onMouseUp)return e.onMouseUp(n,r);break;case"click":if(e.onClick)return e.onClick(n,r)}return!0}function t(e){return[e.layerX,e.layerY]}function n(e){return e.preventDefault(),!1}Modules.prototype.add("surface-interaction",function(t){function r(n){var r=t.surface.getInteractionCallbacks(n.target),i=e(r,n);if(void 0===i&&(i=!0),i){e(t.surface.interactions.common,n)}}t.surface.interactions={},t.surface.setInteraction=function(e,t){e.dataset.interaction=t},t.surface.getInteractionCallbacks=function(e){var n=e.dataset.interaction;return t.surface.interactions[n]},t.surface.onRender=function(e,n){var r=!0,i=t.surface.getInteractionCallbacks(e);if(i.onRender&&(r=i.onRender(n)),r){t.surface.interactions.common.onRender(n)}},t.events.on("surface.create",function(e){e.tabIndex=1e3,e.oncontextmenu=n,e.onkeydown=r,e.onkeyup=r,e.onmousewheel=r,e.onmousemove=r,e.onmousedown=r,e.onmouseup=r,e.onclick=r}),t.events.on("pane.split",function(e,t){var n=e.dataset.interaction;t.dataset.interaction=n})},["surface"])}(),function(){"use strict";function e(e,n){e.uploadRange(n[0]*t,(n[1]-n[0])*t)}var t=Float32Array.BYTES_PER_ELEMENT;Modules.prototype.add("render-solid-cache",function(e){Math.HalfEdgeMesh.prototype.addBuilder("render-solid",n)},["halfedge-cache"]);var n={onCreate:function(e){var t=[];e.faces.forEach(function(e){e.computeNormal();e.getVerticesTriangulated().forEach(function(e){t.push(e[0]._halfEdge.ownIndex,e[1]._halfEdge.ownIndex,e[2]._halfEdge.ownIndex)})});var n=GL.Mesh.load({vertices:new Float32Array(3*e.vertices.length),normals:new Float32Array(3*e.vertices.length),triangles:new Uint16Array(t)});return this.onVerticesChange(e.vertices,n),n},onVerticesChange:function(t,n){for(var r=n.vertexBuffers,i=[Number.MAX_VALUE,0],o=[Number.MAX_VALUE,0],a=0;a<t.length;a++){var s=t[a],c=s._halfEdge.ownIndex;r.vertices.data.set(s,3*c),i[0]=Math.min(i[0],3*c),i[1]=Math.max(i[1],3*c+3);var l=s._halfEdge.computeNormal();r.normals.data.set(l,3*c),o[0]=Math.min(o[0],3*c),o[1]=Math.max(o[1],3*c+3)}e(r.vertices,i),e(r.normals,o)},onClean:function(e){e.vertexBuffers.vertices.dirty&&(e.vertexBuffers.vertices.upload(),delete e.vertexBuffers.vertices.dirty),e.vertexBuffers.normals.dirty&&(e.vertexBuffers.normals.upload(),delete e.vertexBuffers.normals.dirty)}}}(),function(){"use strict";function e(e,t,n,o,a,s){a=a||mat4.create(),e.camera.getViewMatrix(i),mat4.multiply(i,e.camera.projection,i),mat4.multiply(r.u_mvp,i,a),r.u_model=a,n&&(n.uniforms(r),t instanceof Math.HalfEdgeMesh?t&&n.draw(t,o,s):n.draw(t,o,s))}var t=null,n=null;Modules.prototype.add("render-solid",function(i){i.asset.shader.get("solid",function(e){t=e}),i.asset.shader.get("wireframe",function(e){n=e});var o=GL.Mesh.grid({lines:17,size:16}),a=[];o.vertexBuffers.vertices.forEach(function(e,t){a.push(.4,.4,.4,1)}),o.createVertexBuffer("colors","a_color",4,new Float32Array(a));var s=GL.Mesh.load({vertices:new Float32Array([-8,0,0,8,0,0]),colors:new Float32Array([1,0,0,1,1,0,0,1])}),c=GL.Mesh.load({vertices:new Float32Array([0,0,-8,0,0,8]),colors:new Float32Array([0,1,0,1,0,1,0,1])});i.surface.renders.solid=function(a){var l=vec3.create();a.camera.getPosition(l),vec3.add(l,l,[1,2,0]),vec3.normalize(l,l),r.u_lightvector=l;var u=i.graphics.gl;e(a,o,n,u.LINES),u.disable(u.DEPTH_TEST),e(a,s,n,u.LINES),e(a,c,n,u.LINES),u.enable(u.DEPTH_TEST),i.scene.getObjects().forEach(function(n){var r=n.data.mesh.cache.get("render-solid");e(a,r,t,n.data.primitive,n.data.model)})},i.events.on("surface.create",function(e){i.surface.setRender(e,"solid")})},["surface-render","shader","render-solid-cache"]);var r={u_color:[.5,.5,.5,1],u_lightvector:null,u_model:null,u_mvp:mat4.create()},i=mat4.create()}(),function(){"use strict";Modules.prototype.add("surface-render",function(e){e.surface.renders={},e.surface.setRender=function(e,t){e.dataset.render=t},e.surface.getRender=function(t){var n=t.dataset.render;return e.surface.renders[n]};for(var t=document.querySelectorAll(".pane"),n=0;n<t.length;n++)if("surface"==t[n].dataset.paneType){var r=t[n].querySelector("canvas");r.dataset.render="solid"}e.events.on("pane.split",function(e,t){t.attrData("surface-render",e.attrData("surface-render"))})},["surface"])}(),function(){"use strict";Modules.prototype.add("edit-interaction-action-all",function(e){e.surface.interactions.edit.actions.all={init:function(t,n){if(t.selection.isEmpty()){var r=t.selection;e.scene.getObjects().forEach(function(e){var t=r.addAll(e.data);e.data.mesh.cache.onVerticesChange(t)})}else t.selection.clear();t.action=null}}},["edit-interaction"])}(),function(){"use strict";Modules.prototype.add("edit-interaction-action-copy",function(e){function t(e,t){for(var n=[],r=0;r<t.length;r++){var i=Object.assign([],t[r]);delete i._halfEdge,delete i._selected,e.addVertices([i]),n.push(i)}return n}function n(e,t,n,r){for(var i=[],o=0;o<r.length;o++){var a=r[o].getVertices();a=a.map(function(e){return n[t.indexOf(e)]});var s=e.addFace(a);i.push(s)}return i}e.surface.interactions.edit.actions.copy={init:function(r,i){if(r.selection.isEmpty())console.warn("Cannot copy an empty selection!");else for(var o in r.selection.objects){var a=r.selection.objects[o],s=a.vertices,c=a.faces,l=e.scene.getObjects()[0].data,u=l.mesh,d=t(u,s),h=n(u,s,d,c);r.selection.clear();for(var f=0;f<h.length;f++)r.selection.addFace(l,h[f]);u.invalidateCache()}r.action=null}}},["edit-interaction"])}(),function(){"use strict";Modules.prototype.add("edit-interaction-action-delete",function(e){function t(e,t){var n=t._halfEdge.ownIndex;e.vertices.splice(n,1);for(var r=n;r<e.vertices.length;r++)e.vertices[r]._halfEdge.ownIndex--}function n(e,t){var n=t.halfEdge;for(r(e,n);n.next!==t.halfEdge;)n=n.next,r(e,n);var i=e.faces.indexOf(t);e.faces.splice(i,1)}function r(e,t){var n=e.halfEdges.indexOf(t);if(e.halfEdges.splice(n,1),t.opposite){var r=t.opposite.vertex,i=r._halfEdge.outEdges;n=i.indexOf(t),i.splice(n,1)}}e.surface.interactions.edit.actions.delete={init:function(r,i){
if(r.selection.isEmpty())console.warn("Cannot delete an empty selection!");else for(var o in r.selection.objects){var a,s,c=r.selection.objects[o],l=e.scene.getObjects()[0].data.mesh;if(c.faces&&c.faces.length>0)for(a=0;a<c.faces.length;a++){var u=c.faces[a].getVertices();for(n(l,c.faces[a]),s=0;s<u.length;s++)0===u[s]._halfEdge.outEdges.length&&t(l,u[s])}else if(c.vertices&&c.vertices.length>0)for(a=0;a<c.vertices.length;a++){var d=c.vertices[a]._halfEdge.getFaces();for(s=0;s<d.length;s++)n(l,d[s]);t(l,c.vertices[a])}r.selection.clear(),l.invalidateCache()}r.action=null}}},["edit-interaction"])}(),function(){"use strict";Modules.prototype.add("edit-interaction-action-extrude",function(e){function t(e){function t(e){return e.opposite?e.face._selected&&!e.opposite.face._selected:null}for(var n=[],r=null,i=0;i<e.length;i++)for(var o=e[i].getEdges(),a=0;a<o.length;a++){var s=o[a],c=s.opposite.face;c._selected||(r=s)}n.push(r);for(var l=r.vertex._halfEdge.outEdges.find(t);l&&l!=r;)n.push(l),l=l.vertex._halfEdge.outEdges.find(t);return n}function n(e,t,n){for(var r=[],i=[],o=0;o<e.length;o++){var a=Object.assign([],e[o].vertex);a._halfEdge=Object.assign({},e[o].vertex._halfEdge),delete a._selected;for(var s=[],c=e[o].vertex._halfEdge.outEdges,l=0;l<c.length;l++){var u=c[l];u.face._selected&&(c.splice(l,1),s.push(u),l-=1)}a._halfEdge.outEdges=s,i.push(e[o].vertex),r.push(a)}for(n.addVertices(r),o=0;o<t.length;o++)for(var d=t[o].getEdges(),h=0;h<d.length;h++){var f=d[h];if(f.opposite){var v=i.indexOf(f.vertex);v>=0&&(f.vertex=r[v])}else console.debug(f)}for(o=0;o<r.length;o++){var p=o+1>=r.length?0:o+1;n.addFace([i[o],i[p],r[p],r[o]])}}e.surface.interactions.edit.actions.extrude={init:function(r,i){if(r.selection.isEmpty())console.warn("Cannot extrude an empty selection!");else for(var o in r.selection.objects){var a=r.selection.objects[o],s=a.faces,c=e.scene.getObjects()[0].data.mesh,l=t(s);n(l,s,c);r.selection.clear();for(var u=0;u<s.length;u++)r.selection.addFace(e.scene.getObjects()[0].data,s[u]);c.invalidateCache()}r.action=null}}},["edit-interaction"])}(),function(){"use strict";Modules.prototype.add("edit-interaction-action-face",function(e){e.surface.interactions.edit.actions.face={init:function(t,n){if(t.selection.isEmpty())console.warn("Cannot create a face with an empty selection!");else for(var r in t.selection.objects){var i=t.selection.objects[r],o=e.scene.getObjects()[0].data.mesh;i.vertices&&i.vertices.length>0&&o.addFace(i.vertices),t.selection.clear(),o.invalidateCache()}t.action=null}}},["edit-interaction"])}(),function(){"use strict";Modules.prototype.add("edit-interaction-action-move",function(e){var t=vec2.create(),n=null,r=null,i=!1;e.surface.interactions.edit.actions.move={axis:null,init:function(r,i){e.footer.add("[L-Click] Save position; [R-Click] Reset position; [X or Y or Z] Lock to axis;"),vec2.copy(t,r.lastCoords),n=r.selection.getNormal();for(var o in r.selection.objects)for(var a=r.selection.objects[o],s=0;s<a.vertices.length;s++){var c=a.vertices[s];c.originalPosition=c.slice()}},onMouseMove:function(n,i){if(!n.selection.isEmpty()){var o=i.target,a=e.surface.map[o.id],s=a.camera.getRay(null,n.lastCoords,[o.width,o.height]),c=a.camera.getRay(null,t,[o.width,o.height]),l=a.camera.getDirection(),u=[0,0,0],d=[0,0,0],h=n.selection.getCenter();Math.geo.rayPlaneCollision(c.start,c.direction,h,l,u);var f=vec3.create();if(this.axis){var v=vec3.scaleAndAdd(vec3.create(),s.start,s.direction,100),p=vec3.scale(vec3.create(),this.axis,-50),g=vec3.scale(vec3.create(),this.axis,50);Math.geo.closestPointsBetweenSegments(p,g,s.start,v,d),r?vec3.sub(f,d,r):r=vec3.copy(vec3.create(),d)}else Math.geo.rayPlaneCollision(s.start,s.direction,h,l,d),vec3.sub(f,d,u);if(n.isControlDown)for(var m=0;m<3;m++)f[m]=Math.round(f[m]);for(var y in n.selection.objects){for(var b=n.selection.objects[y],M=e.scene.getObjectByName(y),w=0;w<b.vertices.length;w++){var E=b.vertices[w];E.originalPosition&&vec3.add(E,E.originalPosition,f)}M.mesh.onVerticesChange(b.vertices)}}},onMouseDown:function(t,n){if(1===n.which||3===n.which){var r=3===n.which;for(var o in t.selection.objects){for(var a=t.selection.objects[o],s=e.scene.getObjectByName(o),c=0;c<a.vertices.length;c++){var l=a.vertices[c];l.originalPosition&&(r&&vec3.copy(l,l.originalPosition),delete l.originalPosition)}s.mesh.bounds.updateDimensions(),s.mesh.onVerticesChange(s.mesh.vertices)}}i=!1,this.axis=null,t.action=null,e.footer.reset()},onKeyDown:function(e,t){"x"===t.key?this.axis=vec3.set(vec3.create(),1,0,0):"y"===t.key?i?(this.axis=n,i=!1):(this.axis=vec3.set(vec3.create(),0,1,0),i=!0):"z"===t.key&&(this.axis=vec3.set(vec3.create(),0,0,1)),r=null}}},["edit-interaction"])}(),function(){"use strict";Modules.prototype.add("edit-interaction-action-rotate",function(e){var t=vec2.create(),n=vec3.create(),r=vec2.create();vec2.create();e.surface.interactions.edit.actions.rotate={axis:vec3.create(),init:function(i,o){if(i.selection.isEmpty())return void(i.action=null);e.footer.add("[L-Click] Save position; [R-Click] Reset position; [X or Y or Z] Lock to axis;");var a=o.target,s=e.surface.map[a.id],c=i.selection.getCenter();vec3.copy(n,c),vec3.transformMat4(c,c,s.camera.getViewMatrix()),vec3.transformMat4(c,c,s.camera.projection),c[0]=(c[0]+1)/2*a.width,c[1]=(c[1]+1)/2*a.height,vec2.copy(t,c),s.camera.getDirection(this.axis),vec2.sub(r,t,i.lastCoords),vec2.normalize(r,r);for(var l in i.selection.objects)for(var u=i.selection.objects[l],d=0;d<u.vertices.length;d++){var h=u.vertices[d];h.originalPosition=h.slice()}},onMouseMove:function(i,o){if(!i.selection.isEmpty()){var a=vec2.sub(vec2.create(),t,i.lastCoords);vec2.normalize(a,a);var s=a[0]*r[1]-r[0]*a[1],c=Math.atan2(s,vec2.dot(a,r)),l=vec3.negate(vec3.create(),n),u=mat4.create();mat4.translate(u,u,n),mat4.rotate(u,u,c,this.axis),mat4.translate(u,u,l);for(var d in i.selection.objects){for(var h=i.selection.objects[d],f=e.scene.getObjectByName(d),v=0;v<h.vertices.length;v++){var p=h.vertices[v];vec3.transformMat4(p,p.originalPosition,u)}f.mesh.onVerticesChange(h.vertices)}}},onMouseDown:function(t,n){if(1===n.which||3===n.which){var r=3===n.which;for(var i in t.selection.objects){for(var o=t.selection.objects[i],a=e.scene.getObjectByName(i),s=0;s<o.vertices.length;s++){var c=o.vertices[s];c.originalPosition&&(r&&vec3.copy(c,c.originalPosition),delete c.originalPosition)}a.mesh.bounds.updateDimensions(),a.mesh.onVerticesChange(a.mesh.vertices)}}t.action=null,e.footer.reset()},onKeyDown:function(e,t){"x"===t.key?this.axis=vec3.set(vec3.create(),1,0,0):"y"===t.key?this.axis=vec3.set(vec3.create(),0,1,0):"z"===t.key&&(this.axis=vec3.set(vec3.create(),0,0,1))}}},["edit-interaction"])}(),function(){"use strict";Modules.prototype.add("edit-interaction-action-scale",function(e){var t=vec2.create(),n=vec3.create(),r=0,i=vec2.create();e.surface.interactions.edit.actions.scale={axis:null,init:function(o,a){if(o.selection.isEmpty())return void(o.action=null);e.footer.add("[R-Click] Save position; [L-Click] Reset position; [X or Y or Z] Lock to axis;");var s=a.target,c=e.surface.map[s.id],l=o.selection.getCenter();vec3.copy(n,l),vec3.transformMat4(l,l,c.camera.getViewMatrix()),vec3.transformMat4(l,l,c.camera.projection),l[0]=(l[0]+1)/2*s.width,l[1]=(l[1]+1)/2*s.height,vec2.copy(t,l),vec2.sub(i,o.lastCoords,t),r=vec2.length(i);for(var u in o.selection.objects)for(var d=o.selection.objects[u],h=0;h<d.vertices.length;h++){var f=d.vertices[h];f.originalPosition=f.slice()}},onMouseMove:function(o,a){if(!o.selection.isEmpty()){vec2.sub(i,o.lastCoords,t);var s=vec2.length(i)/r,c=vec3.scale(vec3.create(),this.axis||[1,1,1],s),l=vec3.negate(vec3.create(),n),u=mat4.create();mat4.translate(u,u,n),mat4.scale(u,u,c),mat4.translate(u,u,l);for(var d in o.selection.objects){for(var h=o.selection.objects[d],f=e.scene.getObjectByName(d),v=0;v<h.vertices.length;v++){var p=h.vertices[v];vec3.transformMat4(p,p.originalPosition,u)}f.mesh.onVerticesChange(h.vertices)}}},onMouseDown:function(t,n){if(1===n.which||3===n.which){var r=3===n.which;for(var i in t.selection.objects){for(var o=t.selection.objects[i],a=e.scene.getObjectByName(i),s=0;s<o.vertices.length;s++){var c=o.vertices[s];c.originalPosition&&(r&&vec3.copy(c,c.originalPosition),delete c.originalPosition)}a.mesh.bounds.updateDimensions(),a.mesh.onVerticesChange(a.mesh.vertices)}}this.axis=null,t.action=null,e.footer.reset()},onKeyDown:function(e,t){"x"===t.key?this.axis=vec3.set(vec3.create(),1,0,0):"y"===t.key?this.axis=vec3.set(vec3.create(),0,1,0):"z"===t.key&&(this.axis=vec3.set(vec3.create(),0,0,1))}}},["edit-interaction"])}(),function(){"use strict";Modules.prototype.add("edit-interaction-action-subdivide",function(e){function t(e,t){var r,i,o,a,s,c=e.getEdges(),l=e.getVertices(),u=0,d=[0,0,0];if(3===l.length){for(r=0;r<l.length;r++)i=r+1,i=i===l.length?0:i,d=[0,0,0],vec3.add(d,l[r],l[i]),vec3.scale(d,d,.5),t.addVertices([d]),o=u+1,o=o===c.length?0:o,c[o].opposite&&(a=c[o].opposite.face.getVertices(),s=a.indexOf(l[r]),a.splice(s,0,d),n(t,c[o].opposite.face),t.addFace(a)),l.splice(r+1,0,d),u+=1,r+=1;return l}if(4===l.length){for(r=0;r<l.length;r++)i=r+1,i=i===l.length?0:i,d=[0,0,0],vec3.add(d,l[r],l[i]),vec3.scale(d,d,.5),t.addVertices([d]),o=u+1,o=o===c.length?0:o,c[o].opposite&&(a=c[o].opposite.face.getVertices(),s=a.indexOf(l[r]),a.splice(s,0,d),n(t,c[o].opposite.face),t.addFace(a)),l.splice(r+1,0,d),u+=1,r+=1;return d=[0,0,0],vec3.add(d,d,l[0]),vec3.add(d,d,l[2]),vec3.add(d,d,l[4]),vec3.add(d,d,l[6]),vec3.scale(d,d,.25),t.addVertices([d]),l.push(d),l}return console.debug("Can only subdivide 3 or 4 sides polygons!"),null}function n(e,t){var n=t.halfEdge;for(r(e,n);n.next!==t.halfEdge;)n=n.next,r(e,n);var i=e.faces.indexOf(t);e.faces.splice(i,1)}function r(e,t){var n=e.halfEdges.indexOf(t);if(e.halfEdges.splice(n,1),t.opposite){var r=t.opposite.vertex,i=r._halfEdge.outEdges;n=i.indexOf(t),i.splice(n,1)}}e.surface.interactions.edit.actions.subdivide={init:function(r,i){if(r.selection.isEmpty())console.warn("Cannot subdivide an empty selection!");else for(var o in r.selection.objects){var a=r.selection.objects[o],s=e.scene.getObjects()[0].data.mesh;if(a.faces&&a.faces.length>0)for(var c=0;c<a.faces.length;c++){var l=t(a.faces[c],s);null!==l&&(n(s,a.faces[c]),6===l.length?(s.addFace([l[0],l[1],l[5]]),s.addFace([l[1],l[2],l[3]]),s.addFace([l[5],l[3],l[4]]),s.addFace([l[5],l[1],l[3]])):9===l.length&&(s.addFace([l[0],l[1],l[8],l[7]]),s.addFace([l[1],l[2],l[3],l[8]]),s.addFace([l[8],l[3],l[4],l[5]]),s.addFace([l[7],l[8],l[5],l[6]])))}r.selection.clear(),s.invalidateCache()}r.action=null}}},["edit-interaction"])}(),function(){"use strict";function e(e,n){e.uploadRange(n[0]*t,(n[1]-n[0])*t)}var t=Float32Array.BYTES_PER_ELEMENT;Modules.prototype.add("edit-interaction-render-cache",function(e){Math.HalfEdgeMesh.prototype.addBuilder("edit-interaction-render-wireframe",n),Math.HalfEdgeMesh.prototype.addBuilder("edit-interaction-render-vertices",r)},["edit-interaction","shader"]);var n={onCreate:function(e){var t=[];e.faces.forEach(function(e){e.getVertices().forEach(function(e,n,r){var i=n>=r.length-1?0:n+1;t.push(e._halfEdge.ownIndex),t.push(r[i]._halfEdge.ownIndex)})});var n=GL.Mesh.load({vertices:new Float32Array(3*e.vertices.length),colors:new Float32Array(4*e.vertices.length),lines:new Uint16Array(t)});return this.onVerticesChange(e.vertices,n),n},onVerticesChange:function(t,n){for(var r=n.vertexBuffers,i=[Number.MAX_VALUE,0],o=[Number.MAX_VALUE,0],a=0;a<t.length;a++){var s=t[a],c=s._halfEdge.ownIndex;r.vertices.data.set(s,3*c),i[0]=Math.min(i[0],3*c),i[1]=Math.max(i[1],3*c+3);var l=s._selected?[1,.4,.1,1]:[0,0,0,1];r.colors.data.set(l,4*c),o[0]=Math.min(o[0],4*c),o[1]=Math.max(o[1],4*c+4)}e(r.vertices,i),e(r.colors,o)}},r={onCreate:function(e){var t=GL.Mesh.load({vertices:new Float32Array(3*e.vertices.length),colors:new Float32Array(4*e.vertices.length)});return this.onVerticesChange(e.vertices,t),t},onVerticesChange:function(t,n){for(var r=n.vertexBuffers,i=[Number.MAX_VALUE,0],o=[Number.MAX_VALUE,0],a=0;a<t.length;a++){var s=t[a],c=s._halfEdge.ownIndex;r.vertices.data.set(s,3*c),i[0]=Math.min(i[0],3*c),i[1]=Math.max(i[1],3*c+3);var l=s._selected?[1,.4,.1,1]:[0,0,0,1];r.colors.data.set(l,4*c),o[0]=Math.min(o[0],4*c),o[1]=Math.max(o[1],4*c+4)}e(r.vertices,i),e(r.colors,o)}}}(),function(){"use strict";var e=null;Modules.prototype.add("edit-interaction-render",function(t){function n(e,t,n,r,i,o){i=i||mat4.create(),e.camera.getViewMatrix(h),mat4.multiply(h,e.camera.projection,h),mat4.multiply(d.u_mvp,h,i),d.u_model=i,n&&(n.uniforms(d),t instanceof Math.HalfEdgeMesh?t&&n.draw(t,r,o):n.draw(t,r,o))}function r(e,o,a,s,c){if(i(f,s),n(e,a,o,t.graphics.gl.LINES,f,"wireframe"),c&&s.children)for(var l=0;l<s.children.length;l++)r(e,o,a,s.children[l],t.graphics.gl.LINES)}function i(e,t){mat4.identity(e);var n=[0,0,0],r=[0,0,0];vec3.lerp(r,t.aabb.min,t.aabb.max,.5),mat4.translate(e,e,r),vec3.sub(n,t.aabb.max,t.aabb.min),mat4.scale(e,e,n)}t.asset.shader.get("wireframe",function(t){e=t});for(var o=[],a=[],s=0,c=0;c<2*Math.PI;c+=.1)o[3*s+0]=5*Math.sin(c),o[3*s+1]=5*Math.cos(c),o[3*s+2]=0,a[4*s+0]=1,a[4*s+1]=1,a[4*s+2]=1,a[4*s+3]=1,s++;var l=GL.Mesh.load({vertices:new Float32Array(o),colors:new Float32Array(a)}),u=GL.Mesh.load({vertices:new Float32Array([.5,.5,.5,-.5,.5,.5,.5,-.5,.5,-.5,-.5,.5,.5,.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5]),colors:new Float32Array([.6,.6,.6,1,.6,.6,.6,1,.6,.6,.6,1,.6,.6,.6,1,.6,.6,.6,1,.6,.6,.6,1,.6,.6,.6,1,.6,.6,.6,1]),wireframe:new Uint16Array([0,1,1,3,3,2,2,0,4,5,5,7,7,6,6,4,0,4,1,5,2,6,3,7])}),d={u_mvp:mat4.create()};t.surface.interactions.edit.drawBounds=null,t.surface.interactions.edit.onRender=function(i){var o=this.selection;t.scene.getObjects().forEach(function(a){var s=a.data,c=s.mesh.cache.get("edit-interaction-render-wireframe"),h=s.mesh.cache.get("edit-interaction-render-vertices"),f=t.surface.interactions.edit.drawBounds;if(n(i,c,e,t.graphics.gl.LINES),n(i,h,e,t.graphics.gl.POINTS),null!==f&&r(i,e,u,s.mesh.bounds,f),!o.isEmpty()){var v=o.getCenter();vec3.transformMat4(v,v,i.camera.getViewMatrix()),vec3.transformMat4(v,v,i.camera.projection),v[0]=(v[0]+1)/2*i.camera.width,v[1]=(v[1]+1)/2*i.camera.height,mat4.identity(d.u_mvp),mat4.translate(d.u_mvp,d.u_mvp,[v[0],v[1],0]),mat4.multiply(d.u_mvp,i.camera.ortho,d.u_mvp),e.uniforms(d),e.draw(l,t.graphics.gl.LINE_LOOP)}})};var h=mat4.create(),f=mat4.create()},["edit-interaction","shader","edit-interaction-render-cache"])}(),function(){"use strict";function e(e){var t=document.querySelector("#selection .vertices"),n=document.querySelector("#selection .faces"),r=0,i=0;for(var o in e.objects){var a=e.objects[o];r=a.vertices.length,i=a.faces.length}t.innerHTML=r,n.innerHTML=i}function t(e,t,i){i&&(r(e,t,i,"vertices")?(i._selected=!0,i._halfEdge.getFaces().forEach(function(r){var i=e.objects[t.name].vertices,o=r.getVertices(),a=!0;o.forEach(function(e){a&=i.includes(e)}),a&&!r._selected&&n(e,t,r)})):delete i._selected)}function n(e,n,i){i&&(r(e,n,i,"faces")?(i._selected=!0,i.getVertices().forEach(function(r){r._selected||t(e,n,r)})):delete i._selected)}function r(e,t,n,r){i(e,t);var a=e.objects[t.name][r],s=a.indexOf(n);return s>=0?(a.splice(s,1),o(e,t),!1):(a.push(n),!0)}function i(e,t){var n=t.name;e.objects[n]||(e.objects[n]={faces:[],edges:[],vertices:[]})}function o(e,t){var n=t.name;if(e.objects[n]){var r=e.objects[n];r.vertices.length||r.vertices.length||r.vertices.length||delete e.objects[n]}}function a(e){var t=[];return e.forEach(function(e){e._halfEdge.getFaces().forEach(function(e){-1===t.indexOf(e)&&t.push(e)})}),t}Modules.prototype.add("edit-interaction-selection",function(r){r.surface.interactions.edit.selection={objects:{},addAll:function(n){var r=[],i=this;return n.mesh.vertices.forEach(function(e){t(i,n,e),r.push(e)}),e(this),r},add:function(r,i,o){var s=o.getPosition(),c=this,l={vertex:null,face:null},u=i.mesh.bounds.getCollidingItems(r),d=u.filter(function(e){return Math.geo.rayPointDistance(r.start,r.direction,e)<=.3}),h=Math.geo.findClosestPoint(s,d);h&&(l.vertex=h);var f=a(u);f=f.filter(function(e){return Math.geo.rayFaceCollision(r.start,r.direction,e.getVertices())});var v=Math.geo.findClosestFace(s,f);v&&(l.face=v);var p=l.vertex?Math.geo.pointPointDistance(s,l.vertex):Number.MAX_VALUE;return(l.face?Math.geo.pointPointDistance(s,l.face.computeCenter()):Number.MAX_VALUE)>p?(l.face=null,t(c,i,l.vertex)):(l.vertex=null,n(c,i,l.face)),e(this),l},addFace:function(t,r){n(this,t,r),e(this)},getCenter:function(){var e=Object.keys(this.objects)[0];return Math.geo.computePointsCenter(this.objects[e].vertices)},getNormal:function(){var e=vec3.create();for(var t in this.objects)for(var n=this.objects[t],r=0;r<n.vertices.length;r++){var i=n.vertices[r],o=i._halfEdge.computeNormal();vec3.add(e,e,o)}return vec3.normalize(e,e),e},clear:function(){for(var t in this.objects){for(var n=this.objects[t],i=r.scene.getObjectByName(t),o=0;o<n.faces.length;o++){var a=n.faces[o];a._selected&&delete a._selected}for(o=0;o<n.vertices.length;o++){var s=n.vertices[o];s._selected&&delete s._selected}i.mesh.onVerticesChange(n.vertices)}this.objects={},e(this)},isEmpty:function(){return!Object.keys(this.objects).length}}},["edit-interaction"])}(),function(){"use strict";Modules.prototype.add("edit-interaction",function(e){e.surface.interactions.edit={actions:{},action:null,isMouseDown:!1,isShiftDown:!1,isControlDown:!1,lastCoords:[0,0],onMouseMove:function(e,t){vec2.copy(this.lastCoords,t),this.runAction("onMouseMove",e,t)},onMouseUp:function(e,t){1===e.which&&(this.isMouseDown=!1),this.runAction("onMouseUp",e,t)},onMouseDown:function(t,n){if(!this.action){var r=t.target,i=e.surface.map[r.id];if(1===t.which){this.isMouseDown=!0;var o=i.camera.getRay(null,n,[r.width,r.height]),a=this.selection,s=this.isShiftDown;return e.scene.getObjects().forEach(function(e){s||a.clear();var t=a.add(o,e.data,i.camera);t.vertex&&e.data.mesh.cache.onVerticesChange([t.vertex]),t.face&&e.data.mesh.cache.onVerticesChange(t.face.getVertices())}),!1}}return this.runAction("onMouseDown",t,n),!0},onKeyDown:function(e,t){this.isShiftDown=e.shiftKey,this.isShiftDown=e.ctrlKey,this.action?13===e.keyCode?this.action=null:this.runAction("onKeyDown",e,t):"a"===e.key?this.setAction("all",e):"g"===e.key?this.setAction("move",e):"s"===e.key?this.setAction("scale",e):"r"===e.key?this.setAction("rotate",e):"f"===e.key?this.setAction("face",e):"n"===e.key?this.setAction("subdivide",e):46===e.keyCode?this.setAction("delete",e):"c"===e.key?(this.setAction("copy",e),this.setAction("move",e)):"e"===e.key?(this.setAction("extrude",e),this.setAction("move",e)):"b"===e.key&&(null===this.drawBounds?this.drawBounds=!1:!1===this.drawBounds?this.drawBounds=!0:!0===this.drawBounds&&(this.drawBounds=null))},onKeyUp:function(e,t){this.isShiftDown=e.shiftKey,this.isShiftDown=e.ctrlKey,this.runAction("onKeyUp",e,t)},setAction:function(e,t){e&&this.actions[e]&&(this.action=e,this.runAction("init",t))},runAction:function(e,t){if(this.action&&this.actions[this.action]){var n=this.actions[this.action],r=n[e];r&&r.call(n,this,t)}}},e.events.on("surface.create",function(t){e.surface.setInteraction(t,"edit")})},["surface-interaction"])}(),function(){"use strict";Modules.prototype.add("footer",function(e){var t=document.querySelector(e.options.container.selector),n=document.createElement("div");n.className="footer",e.footer={reset:function(){n.innerHTML=""},add:function(e){n.innerHTML+=e}},t.insertBefore(n,null)})}(),function(){"use strict";function e(e,t){var n=t.clientWidth,r=t.clientHeight,i=e.surface.map[t.id],o=e.graphics.gl,a=e.graphics.gl.canvas;o.viewport(0,a.height-r,n,r),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);var s=e.surface.getRender(t),c=e.surface.onRender;s&&s(i),c&&c(t,i);var l=t.getContext("2d");l&&l.drawImage(a,0,0,n,r,0,0,n,r)}var t=function(t){this.gl=GL.create({height:screen.height,width:screen.width}),this.gl.animate(),this.gl.ondraw=function(){for(var n=document.querySelectorAll("canvas"),r=0;r<n.length;r++)e(t,n[r])},this.gl.clearColor(.223529,.223529,.223529,1),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.GL_EQUAL),this.gl.getExtension("OES_standard_derivatives"),console.info(this.gl.getParameter(this.gl.VERSION)),console.info(this.gl.getParameter(this.gl.SHADING_LANGUAGE_VERSION))};Modules.prototype.add("graphics",function(e){e.graphics=new t(e)})}(),function(){"use strict";function e(e,t){var n=document.createElement("a");n.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),n.setAttribute("download",e),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}function t(e){var t="";console.debug(e);for(var n=0;n<e.vertices.length;n++){var r=e.vertices[n];t+="v ",t+=r[0]+" ",t+=r[1]+" ",t+=r[2]+"\r\n"}for(t+="s off\r\n",n=0;n<e.faces.length;n++){var i=e.faces[n],o=i.halfEdge;for(t+="f "+(o.vertex._halfEdge.ownIndex+1);o.next!=i.halfEdge;)o=o.next,t+=" "+(o.vertex._halfEdge.ownIndex+1);t+="\r\n"}return t}function n(e,t){var n=document.createElement("button");return n.style.marginLeft="5px",n.innerHTML=e,n.onclick=t,n}Modules.prototype.add("main-menu",function(r){function i(e){var t=e.target.files;if(t.length>0){var n=new FileReader;n.onload=function(e){var t=r.asset.mesh.build(e.target.result);r.scene.addObject({mesh:t})},n.readAsText(t[0])}}var o=document.querySelector(r.options.container.selector),a=document.querySelector("#cobweb-file");a.addEventListener("change",i);var s=document.createElement("div");s.className="main-menu",s.appendChild(n("Toggle Help",function(){var e=document.querySelector("#surface-help");e.style.display?e.style.display="":e.style.display="none"})),s.appendChild(n("Download Object",function(){if(r.scene.children.length>0){e("export.obj",t(r.scene.children[0].data.mesh))}})),s.appendChild(n("Upload Object",function(){if(r.scene.children.length>0){if(!confirm("The current mesh will be removed. Are you sure?"))return}r.scene.children=[],window.FileReader?a.click():alert("window.FileReader is undefined, File API not present!")})),s.innerHTML+=" Cobweb v1.0.0",o.insertBefore(s,o.firstChild)})}(),function(){"use strict";function e(t,n){for(var r=0;r<t.children.length;r++){var i=t.children[r];if(i.data.name===n)return i.data;var o=e(i,n);if(o)return o.data}return null}var t=0;Modules.prototype.add("scene",function(n){n.scene=TreeNode.extend(),n.scene.addObject=function(e){e.primitive||(e.primitive=n.graphics.gl.TRIANGLES),e.model||(e.model=mat4.create()),e.type||(e.type="object"),e.name||(e.name="object_"+t++),this.add(e)},n.scene.getObjectByName=function(t){return e(this,t)},n.scene.getObjects=function(){return this.dfs(function(e){return"object"===e.data.type})},n.asset.mesh.get("cube",function(e){n.scene.addObject({mesh:e})})},["graphics"])}();
//# sourceMappingURL=cobweb.min.js.map
